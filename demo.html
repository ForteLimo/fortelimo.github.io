<!DOCTYPE html> 
	<head>
		<script src="assets/js/d3.min.js"></script>	
		<script src="assets/js/jquery-2.1.4.min.js"></script>
		<script src="assets/js/plotly-basic.js"></script>
		<!-- Code online
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
		<script src="https://d14fo0winaifog.cloudfront.net/plotly-basic.js"></script> -->
	</head>
	<body>
		 <div class="showcase__section" id="bubble">
        <div class="spacer --small"></div>
        <div id="bubbleplots">
            <div class="bubbleplot" data-num="0">
                <div class="plot"></div>
                <div class="control-row">
                    X: <select class="xdata"></select>
                </div>
                <div class="control-row">
                    Y: <select class="ydata"></select>
                </div>
            </div>
            <div class="bubbleplot" data-num="1">
                <div class="plot"></div>
                <div class="control-row">
                    X: <select class="xdata"></select>
                </div>
                <div class="control-row">
                    Y: <select class="ydata"></select>
                </div>
            </div>
            <div class="bubbleplot" data-num="2">
                <div class="plot"></div>
                <div class="control-row">
                    X: <select class="xdata"></select>
                </div>
                <div class="control-row">
                    Y: <select class="ydata"></select>
                </div>
            </div>
            <div class="bubbleplot" data-num="3">
                <div class="plot"></div>
                <div class="control-row">
                    X: <select class="xdata"></select>
                </div>
                <div class="control-row">
                    Y: <select class="ydata"></select>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    	function () {
        var gdp = loadCSV('gdp_data'),
            options = Object.keys(gdp),
            lifetime = loadCSV('lifetime_data'),
            initialSettings = [
                ['year', 'Australia'],
                ['year', 'Nigeria'],
                ['Australia', 'Nigeria'],
                ['United States', 'Euro area']
            ],
            numPlots = initialSettings.length,
            container = document.getElementById('bubbleplots'),
            i,
            j,
            innerContainer,
            plotEl,
            xSelector,
            ySelector;

        function setBubblePlot(plotEl, xSelector, ySelector) {
            return function() {
                var xdata = xSelector.value,
                    ydata = ySelector.value;

                var data = {
                    x: gdp[xdata],
                    y: gdp[ydata],
                    marker: {size: 12},
                    mode: 'lines+markers'
                };

                if(ydata !== 'year') {
                    data.marker = {
                        size: lifetime[ydata],
                        sizeref: lifetime[ydata][0] / 10,
                        sizemode: 'diameter'
                    };
                    data.text = lifetime[ydata].map(function(p, i) {
                        var out = xdata==='year' ? '' : (gdp.year[i] + '
');
                        out += ydata + ' lifetime: ' + (Math.round(p*10)/10);
                        return out;
                    });
                }

                var layout = {
                    xaxis: axisInfo(xdata),
                    yaxis: axisInfo(ydata)
                };


                Plotly.Plots.purge(plotEl);
                Plotly.plot(plotEl, [data], layout);
            };
        }

        function handleHover(plotNumber) {
            return function(event, hoverdata) {
                var pointNumber = hoverdata.points[0].pointNumber,
                    i,
                    otherPlot,
                    otherHover;

                for(i = 0; i < numPlots; i++) {
                    if(i === plotNumber) continue;
                    otherPlot = container.querySelector('[data-num="' + i + '"] .plot');
                    otherHover = {curveNumber: 0, pointNumber: pointNumber};
                    Plotly.Fx.hover(otherPlot, [otherHover]);
                }
            };
        }

        function handleUnhover(plotNumber) {
            return function() {
                var otherPlot,
                    i;

                for(i = 0; i < numPlots; i++) {
                    if(i === plotNumber) continue;
                    otherPlot = container.querySelector('[data-num="' + i + '"] .plot');
                    Plotly.Fx.unhover(otherPlot);
                }
            };
        }

        for(i = 0; i < numPlots; i++) {
            innerContainer = container.querySelector('[data-num="' + i + '"]');
            plotEl = innerContainer.querySelector('.plot');
            xSelector = innerContainer.querySelector('.xdata');
            ySelector = innerContainer.querySelector('.ydata');

            for(j = 0; j < options.length; j++) {
                xSelector.appendChild(newOption(options[j]));
                ySelector.appendChild(newOption(options[j]));
            }

            xSelector.value = initialSettings[i][0];
            ySelector.value = initialSettings[i][1];

            var updatePlot = setBubblePlot(plotEl, xSelector, ySelector);

            xSelector.addEventListener('change', updatePlot);
            ySelector.addEventListener('change', updatePlot);
            updatePlot();

            $(plotEl)
                .off('plotly_hover plotly_unhover')
                .on('plotly_hover', handleHover(i))
                .on('plotly_unhover', handleUnhover(i));
        }

    }
    
    </script>
	</body>
</html>
